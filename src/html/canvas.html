<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div style="width: 300px; height: 300px; position: relative">
      <canvas style="background-color: #fff" id="canvas"></canvas>
      <div
        style="
          /* background-color: #fff; */
          width: 300px;
          height: 300px;
          position: absolute;
          top: 0;
          left: 0;
        "
      ></div>
    </div>

    <script>
      const CanvasWidth = 300;
      const CanvasHeight = 300;
      const font = '100px Arial';
      const text = 'Github';

      const canvas = document.getElementById('canvas');
      canvas.width = CanvasWidth;
      canvas.height = CanvasHeight;
      const context = canvas.getContext('2d');

      const attrs = context.getContextAttributes();
      console.log('context attributes: ', attrs);

      const backgroundColors = [
        {
          color: '#fff',
          percent: 0.5,
        },
        {
          color: '#666',
          percent: 0.5,
        },
      ];
      const forgegroundColors = [
        {
          color: '#f66',
          percent: 0.5,
        },
        {
          color: '#F99',
          percent: 0.5,
        },
      ];

      context.fillStyle = '#fff';
      context.fillRect(0, 0, CanvasWidth, CanvasHeight);
      context.textBaseline = 'middle';
      context.fillStyle = '#000';
      context.font = font;
      context.fillText(text, 0, CanvasHeight / 2, CanvasWidth);
      const width = context.measureText(text).width;
      console.log('width: ', width);

      const imageData = context.getImageData(0, 0, CanvasWidth, CanvasHeight);
      // console.log('image data: ', imageData);

      function compositeColor(r, g, b, a) {
        return `(${r},${g},${b},${a})`;
      }

      function formatColor(color, alpha) {
        let result = [0, 0, 0, 0];
        if (color[0] === '#') {
          //#fff #ffffff #fffa #ffffffaa
          if (color.length === 4) {
            result[0] = (parseInt(color[1], 16) / 15) * 255;
            result[1] = (parseInt(color[2], 16) / 15) * 255;
            result[2] = (parseInt(color[3], 16) / 15) * 255;
            result[3] = 255;
          } else if (color.length === 5) {
            result[0] = (parseInt(color[1], 16) / 15) * 255;
            result[1] = (parseInt(color[2], 16) / 15) * 255;
            result[2] = (parseInt(color[3], 16) / 15) * 255;
            result[3] = (parseInt(color[4], 16) / 15) * 255;
          } else if (color.length === 6) {
            result[0] = parseInt(color.substring(1, 3), 16);
            result[1] = parseInt(color.substring(3, 5), 16);
            result[2] = parseInt(color.substring(5, 7), 16);
            result[3] = 255;
          } else if (color.length === 8) {
            result[0] = parseInt(color.substring(1, 3), 16);
            result[1] = parseInt(color.substring(3, 5), 16);
            result[2] = parseInt(color.substring(5, 7), 16);
            result[3] = parseInt(color.substring(7, 9), 16);
          }
        } else if (color[0] === 'r') {
          // rgb(0,0,0) rgba(1,2,3,3)
          if (color.startsWith('rgba')) {
            const list = color.substring(4, color.length - 1).split(',');
            result[0] = parseInt(list[0], 10);
            result[1] = parseInt(list[1], 10);
            result[2] = parseInt(list[2], 10);
            result[3] = parseInt(list[3], 10);
          } else if (color.startsWith('rgb')) {
            const list = color.substring(5, color.length - 1).split(',');
            result[0] = parseInt(list[0], 10);
            result[1] = parseInt(list[1], 10);
            result[2] = parseInt(list[2], 10);
            result[3] = 255;
          }
        }
        if (alpha) {
          result[3] = alpha;
        }
        return result;
      }

      function getColor(col, total, colors) {
        const current = col / total;
        let cursor = 0;
        for (let i = 0; i < colors.length; i += 1) {
          const next = cursor + colors[i].percent;
          if (current >= cursor && current <= next) {
            return colors[i].color;
          }
          cursor = next;
        }
      }

      const { data, width: imgWidth, height: imgHeight } = imageData;
      let row = 0;
      let col = 0;
      let delta = [];
      // 包含以 RGBA 顺序的数据
      console.log('image data Uint8ClampedArray: ', data.length);
      // console.log('image data width ', imgWidth);
      // console.log('image data height ', imgHeight);

      // console.log(formatColor('#fac'));
      // console.log(formatColor('rgb(23,45,44)'));

      function formateBoundColor(origin = [], from = [], to = []) {
        const rates = [
          origin[0] / 255,
          origin[1] / 255,
          origin[2] / 255,
          origin[3] / 255,
        ];
      }

      function modifyImageData(startIndex, color) {
        imageData.data[startIndex] = color[0];
        imageData.data[startIndex + 1] = color[1];
        imageData.data[startIndex + 2] = color[2];
        imageData.data[startIndex + 3] = color[3];
      }

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        col += 1;
        if (col === imgWidth) {
          row += 1;
          col = 0;
          delta = [];
        }
        if (col > 0) {
          delta = [
            r - data[i - 4],
            g - data[i - 3],
            b - data[i - 2],
            a - data[i - 1],
          ];
        }
        const isBackground = r === 255 && g === 255 && b === 255 && a === 255;
        const isForgeGround = r === 0 && g === 0 && b === 0 && a === 255;
        let newColor;
        let formatedColor;
        if (isBackground) {
          newColor = getColor(col, imgWidth, backgroundColors);
          formatedColor = formatColor(newColor);
          modifyImageData(i, formatedColor);
        } else if (isForgeGround) {
          newColor = getColor(col, imgWidth, forgegroundColors);
          formatedColor = formatColor(newColor);
          modifyImageData(i, formatedColor);
        } else {
          // console.log(`row: ${row}, col: ${col}`);
          // console.log('point color: ', compositeColor(r, g, b, a));
          // newColor = getColor(col, imgWidth, backgroundColors);
          // formatedColor = formatColor(newColor);
          // formatedColor = formateBoundColor([r, g, b, a], formatedColor);
          // modifyImageData(i, formatedColor);
          if (row === 105) {
            console.log(`row: ${row}, col: ${col}`);
            console.log('point color: ', compositeColor(r, g, b, a));
            console.log('delta: ', delta);
            // console.log('formated color: ', formatedColor);
          }
        }
      }

      context.putImageData(imageData, 0, 0);
    </script>
  </body>
</html>
