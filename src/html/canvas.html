<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div style="width: 300px; height: 300px; position: relative">
      <canvas style="background-color: #fff" id="canvas"></canvas>
      <div
        style="
          background-color: #fff;
          width: 300px;
          height: 300px;
          position: absolute;
          top: 0;
          left: 0;
        "
      ></div>
    </div>

    <script>
      const CanvasWidth = 300;
      const CanvasHeight = 300;
      const font = '100px Arial';
      const text = 'Github';

      const canvas = document.getElementById('canvas');
      canvas.width = CanvasWidth;
      canvas.height = CanvasHeight;
      const context = canvas.getContext('2d');

      const attrs = context.getContextAttributes();
      console.log('context attributes: ', attrs);

      const backgroundColors = [
        {
          color: 'rgb(255,255,255)',
          percent: 0.5,
        },
        {
          color: 'rgb(192,192,192)',
          percent: 0.5,
        },
      ];
      const forgegroundColors = [
        {
          color: 'rgb(255,192,22)',
          percent: 0.5,
        },
        {
          color: 'rgb(23,212,99)',
          percent: 0.5,
        },
      ];

      context.fillStyle = '#fff';
      context.fillRect(0, 0, CanvasWidth, CanvasHeight);
      context.textBaseline = 'middle';
      context.fillStyle = '#000';
      context.font = font;
      context.fillText(text, 0, CanvasHeight / 2, CanvasWidth);
      const width = context.measureText(text).width;
      console.log('width: ', width);

      const imageData = context.getImageData(0, 0, CanvasWidth, CanvasHeight);
      // console.log('image data: ', imageData);

      function compositeColor(r, g, b, a) {
        return `(${r},${g},${b},${a})`;
      }

      function interpolate(
        array,
        inputStart,
        inputEnd,
        targetStart,
        targetEnd
      ) {
        const [first] = array;
        const result = [];
        let span = 0;
        let factor = 0;
        let targetSpan = 0;

        if (first === inputStart) {
          result.push(targetStart);
          span = inputEnd - inputStart;
          targetSpan = targetEnd - targetStart;
        } else if (first === inputEnd) {
          result.push(targetEnd);
          targetSpan = targetStart - targetEnd;
          span = inputStart - inputEnd;
        }

        for (let i = 1; i < array.length; i += 1) {
          const delta = array[i] - array[i - 1];
          factor = (delta / span) * targetSpan;
          result.push(result[i - 1] + factor);
        }
      }

      function formatColor(color, alpha) {
        let result = [0, 0, 0, 0];
        if (color[0] === '#') {
          //#fff #ffffff #fffa #ffffffaa
          if (color.length === 4) {
            result[0] = (parseInt(color[1], 16) / 15) * 255;
            result[1] = (parseInt(color[2], 16) / 15) * 255;
            result[2] = (parseInt(color[3], 16) / 15) * 255;
            result[3] = 255;
          } else if (color.length === 5) {
            result[0] = (parseInt(color[1], 16) / 15) * 255;
            result[1] = (parseInt(color[2], 16) / 15) * 255;
            result[2] = (parseInt(color[3], 16) / 15) * 255;
            result[3] = (parseInt(color[4], 16) / 15) * 255;
          } else if (color.length === 7) {
            result[0] = parseInt(color.substring(1, 3), 16);
            result[1] = parseInt(color.substring(3, 5), 16);
            result[2] = parseInt(color.substring(5, 7), 16);
            result[3] = 255;
          } else if (color.length === 9) {
            result[0] = parseInt(color.substring(1, 3), 16);
            result[1] = parseInt(color.substring(3, 5), 16);
            result[2] = parseInt(color.substring(5, 7), 16);
            result[3] = parseInt(color.substring(7, 9), 16);
          }
        } else if (color[0] === 'r') {
          // rgb(0,0,0) rgba(1,2,3,3)
          if (color.startsWith('rgba')) {
            const list = color.substring(5, color.length - 1).split(',');
            result[0] = parseInt(list[0], 10);
            result[1] = parseInt(list[1], 10);
            result[2] = parseInt(list[2], 10);
            result[3] = parseInt(list[3], 10);
          } else if (color.startsWith('rgb')) {
            const list = color.substring(4, color.length - 1).split(',');
            result[0] = parseInt(list[0], 10);
            result[1] = parseInt(list[1], 10);
            result[2] = parseInt(list[2], 10);
            result[3] = 255;
          }
        }
        if (alpha) {
          result[3] = alpha;
        }
        // console.log('format color: input = ', color, ', output = ', result);
        return result;
      }

      function getColor(col, total, colors) {
        const current = col / total;
        let cursor = 0;
        for (let i = 0; i < colors.length; i += 1) {
          const next = cursor + colors[i].percent;
          if (current >= cursor && current <= next) {
            return colors[i].color;
          }
          cursor = next;
        }
      }

      const { data, width: imgWidth, height: imgHeight } = imageData;
      let row = 0;
      let col = 0;
      let delta = [];
      // 包含以 RGBA 顺序的数据
      console.log('image data Uint8ClampedArray: ', data.length);
      // console.log('image data width ', imgWidth);
      // console.log('image data height ', imgHeight);

      // console.log(formatColor('#fac'));
      // console.log(formatColor('rgb(23,45,44)'));

      function formateBoundColor(origin = [], from = [], to = []) {
        const rates = [
          origin[0] / 255,
          origin[1] / 255,
          origin[2] / 255,
          origin[3] / 255,
        ];
      }

      function modifyImageData(startIndex, color) {
        imageData.data[startIndex] = color[0];
        imageData.data[startIndex + 1] = color[1];
        imageData.data[startIndex + 2] = color[2];
        imageData.data[startIndex + 3] = color[3];
      }

      function updateImageData(index, value) {
        // if (index >= 4 * imgWidth * 110 && index < 4 * imgWidth * 111) {
        //   console.log(`index:${index}, value:${value}`);
        // }
        imageData.data[index] = value;
      }

      function calInterpolateValue(
        prevStart,
        prevEnd,
        nextStart,
        nextEnd,
        accStep
      ) {
        const pd = prevEnd - prevStart;
        const nd = nextEnd - nextStart;
        return nextStart + (accStep / pd) * nd;
      }

      const backgroundValue = 255;
      const forgegroundValue = 0;
      let targetBackgroundValue = 0;
      let targetForgegroundValue = 0;
      let [lastR, lastG, lastB, lastA] = data;
      let lastValues = [lastR, lastG, lastB, lastA];
      let accValues = [0, 0, 0, 0];

      for (let i = 0; i < data.length; i += 1) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        const targetBackground = getColor(col, imgWidth, backgroundColors);
        const targetForgeground = getColor(col, imgWidth, forgegroundColors);

        const bgc = formatColor(targetBackground);
        const fgc = formatColor(targetForgeground);

        const value = data[i];
        if (i % 4 === 3) {
          col += 1;
          // A
          // updateImageData(i, 255)
          if (col === imgWidth) {
            // if (row === 110) {
            //   console.log('row data: ', rowData);
            //   const newRow = handleRowData(
            //     rowData,
            //     targetBackground,
            //     targetForgeground
            //   );
            //   console.log('new row: ', newRow);
            // }
            row += 1;
            col = 0;
          }
          // continue;
        }
        let delta = 0;
        let accValue = 0;

        const j = i % 4;
        targetBackgroundValue = bgc[j];
        targetForgegroundValue = fgc[j];
        delta = value - lastValues[j];

        if (delta === 0) {
          accValues[j] = 0;
          if (value === forgegroundValue) {
            updateImageData(i, targetForgegroundValue);
          } else if (value === backgroundValue) {
            updateImageData(i, targetBackgroundValue);
          } else {
            console.log(`row: ${row}, col: ${col}, index: ${i}`);
            console.log('value is not forgeground or background: ', value);
          }
        } else {
          accValues[j] += delta;
          let nextValue =
            accValue > 0
              ? calInterpolateValue(
                  forgegroundValue,
                  backgroundValue,
                  targetForgegroundValue,
                  targetBackgroundValue,
                  accValues[j]
                )
              : calInterpolateValue(
                  backgroundValue,
                  forgegroundValue,
                  targetBackgroundValue,
                  targetForgegroundValue,
                  accValues[j]
                );
          if (row === 110) {
            console.log(
              `row: ${row}, col: ${col}, delta: ${delta}, acc value: ${accValue}
              ${forgegroundValue} -> ${backgroundValue}, 
              target: ${targetForgegroundValue} -> ${targetBackgroundValue}，
              current: ${value} -> ${nextValue}`
            );
          }
          updateImageData(i, nextValue);
        }
      }

      context.putImageData(imageData, 0, 0);
    </script>
  </body>
</html>
